<!doctype html>
<html>
<head>
    <title>채팅 읽어주는 로봇</title>
    <meta charset="utf-8">
    <link rel="favicon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.11.0/alertify.min.js"></script>
    <script src="md5.min.js"></script>
    <script src="jquery.min.js"></script>
    <script src="jsDynamicLoader.js"></script>
    <script src="ttsHandler.js"></script>
    <script src="specialchat.js"></script>
    <script src="tapic.min.js"></script>
    <script src="tapicHandler.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.11.0/css/alertify.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.11.0/css/themes/bootstrap.min.css" />
</head>
<body style='margin: 10px;'>
    <div id="chat" style="overflow: hidden; word-wrap: break-word; width: 800px;">
        <button type="button" class="btn btn-danger" id="btn-cancel" onclick="onClearQueueClick()">로봇 시작</button>
        <button type="button" class="btn btn-warning" onclick="localStorage.setItem('oauth','');location.reload();" id="btn-logout">로그아웃</button>
        <button type="button" class="btn btn-success" onclick="window.change_channel();" id="btn-channel">채널 변경</button><br />
        <div id="last_read">(없음)</div>
    </div>

    <br>
    <div>테스트<input onkeypress="onTestTextBoxkeydown(event)" id="testTextBox" type="text" style="margin-left: 5px"></div>

    <hr style='border-width: 2px;'>
    <h3>스페셜 보이스</h3>
    <div id='voicewaresTable'></div><br>
    <h3>스페셜 챗</h3>
    <div>목록을 한줄로<input readonly="readonly" id="specialchatjoin" type="text" style="margin-left: 5px"></div>
    <div id='masterVolume' class='volume'><label style='margin-right: 10px'>마스터볼륨</label><label name='label' style='margin-right: 10px'>000%</label><input name='input' type='range' min='0' max='100' value='0' onchange='onMasterVolumeChange(this)'></div>
    <div id="clipsTable" class='volumecontainer' />

    <script>

        window.setupPhase = 0;

        function onClearQueueClick()
        {
            if (window.setupPhase == 1)
            {
                window.setupPhase = 2;
                setupTTS();

                $("#btn-cancel")[0].disabled = true;
                $("#btn-cancel")[0].innerHTML = "로봇 시작 중";
            }
            else if (window.setupPhase == 1)
            {

            }
            else if (window.setupPhase == 2)
            {
                this.clear();

                enqueueText('큐를 비웠습니다', 1.3, 1, 'SYSTEM');
            }

        }

        function setup()
        {
            // 트위치 개발자 사이트에서 앱 등록으로 client id를 발급받으실수 있습니다.
            window.oauth_client_id = "qp7etii0xqtqy5qs037zpb6ze5nvyu";

            var urihost = new URL(window.location.href);
            window.oauth_redirect_uri = urihost.origin + urihost.pathname;
		
		
		// 인증후 돌아올 페이지(현재 페이지 주소)를 입력합니다.
        window.oauth_redirect_uri = "https://yooya200.github.io/ChatTTS/chat_tts.html";
		
            // 스페셜챗 json 주소
            window.sounds_list_uri = urihost.origin + getParent(urihost.pathname) + "/chat_tts_list.json";

            alertify.defaults.transition = "slide";
            alertify.defaults.theme.ok = "btn btn-primary";
            alertify.defaults.theme.cancel = "btn btn-danger";
            alertify.defaults.theme.input = "form-control";
            alertify.set('notifier', 'position', 'top-center');

            // oauth token으로 처음 페이지 접속시 트위치 로그인으로 생성함(로컬스토리지 저장, 로그아웃시 초기화됨)
             window.oauth = localStorage.getItem("oauth") !== null ? localStorage.getItem("oauth") : "";
		window.login = localStorage.getItem("login") !== null && localStorage.getItem("login") !== "undefined" ? localStorage.getItem("login") : "";
        	window.display_name = localStorage.getItem("display_name") !== null && localStorage.getItem("display_name") !== "undefined" ? localStorage.getItem("display_name") : "";
        	window.last_login_date = localStorage.getItem("last_login_date") !== null && localStorage.getItem("last_login_date") !== "undefined" ? parseInt(localStorage.getItem("last_login_date")) : -1;
            
		        const url_string = window.location.href;
        const url = new URL(url_string);

        if ('speechSynthesis' in window) {
            console.debug("TTS check done");
        } else {
            location.href = "./no_tts.html";
        }

        // 주소뒤 ?channel=(채널아이디) 로 지정
        window.channelname = getParams("channel");
        
        // 채널명 없으면 비워둠
        if (window.channelname === null) window.channelname = "";
        
        // 클릭 여부 저장
        window.isclicked = false;
        
        // 자동스크롤 중단 여부
        window.stopScroll = localStorage.getItem("autoscroll") === "false";
        if(!window.stopScroll) {
            document.getElementById("chk-autoscroll").checked = true;
            scrollBottom();
        }

        // oauth token으로 처음 페이지 접속시 트위치 로그인으로 생성함(로컬스토리지 저장, 로그아웃시 초기화됨)
        window.oauth = localStorage.getItem("oauth") !== null ? localStorage.getItem("oauth") : "";
        window.login = localStorage.getItem("login") !== null && localStorage.getItem("login") !== "undefined" ? localStorage.getItem("login") : "";
        window.display_name = localStorage.getItem("display_name") !== null && localStorage.getItem("display_name") !== "undefined" ? localStorage.getItem("display_name") : "";
        window.last_login_date = localStorage.getItem("last_login_date") !== null && localStorage.getItem("last_login_date") !== "undefined" ? parseInt(localStorage.getItem("last_login_date")) : -1;

        // 주소뒤 ?debug=true 로 디버그모드 활성화
        window.debugmode = getParams("debug") === "true";

        // 읽을 채팅 최대 길이(!!tts maxlength (길이)로 변경가능)
        window.maxlength = localStorage.getItem("tts_maxlength") !== null ? parseInt(localStorage.getItem("tts_maxlength")) : 40;

        // 읽을 채팅 음량 (!!tts volume (음량)으로 변경가능)
        window.volume = localStorage.getItem("tts_volume") !== null ? parseInt(localStorage.getItem("tts_volume")) : 100;

        // 차단 목록(로컬스토리지 저장, !!tts ban (아이디) 로 밴하고 !!tts unban (아이디)로 밴 해제)
        window.banlist = localStorage.getItem("tts_banlist_" + window.channelname) !== null ? localStorage.getItem("tts_banlist_" + window.channelname).split("|") : [];
        
        // 허용 목록(로컬스토리지 저장, !!tts addlist (아이디) 로 추가하고 !!tts removelist (아이디)로 삭제)
        window.whitelist = (localStorage.getItem("tts_whitelist_" + window.channelname) !== null && localStorage.getItem("tts_whitelist_" + window.channelname) !== "") ? localStorage.getItem("tts_whitelist_" + window.channelname).split("|") : [];

        // 밴키워드(로컬스토리지 저장, !!tts ban (아이디) 로 밴하고 !!tts unban (아이디)로 밴 해제)
        window.bankeyword = localStorage.getItem("tts_bankeyword_" + window.channelname) !== null ? localStorage.getItem("tts_bankeyword_" + window.channelname).split("|") : [];

        // 기본적으로 밴할 리스트
        window.banlist = window.banlist.concat(['Nightbot', '싹둑']);

        // 기본적으로 밴할 키워드
        window.bankeyword = window.bankeyword.concat(['섹스']);
        
        // 각 리스트 모두 중복 제거
        if(window.banlist.length != 0) {
            window.banlist = window.banlist.filter(function(item, pos) {
                return window.banlist.indexOf(item) == pos;
            });
        }
        if(window.whitelist.length != 0) {
            window.whitelist = window.whitelist.filter(function(item, pos) {
                return window.whitelist.indexOf(item) == pos;
            });
        }
        if(window.bankeyword.length != 0) {
            window.bankeyword = window.bankeyword.filter(function(item, pos) {
                return window.bankeyword.indexOf(item) == pos;
            });
        }

        // 구독자 전용
        window.tts_subonly = localStorage.getItem("tts_subonly") === "true";

        // 개설자 전용
        window.tts_founderonly = localStorage.getItem("tts_founderonly") === "true";

        // 보이스 개인화 설정
        window.uniq_voice = localStorage.getItem("uniq_voice") !== "false";

        // 기본 보이스
        window.def_voice = localStorage.getItem("def_voice") !== null ? localStorage.getItem("def_voice") : "default";

        // 초기화 성공 여부
        window.initok = false;

        window.mod_speed = 1;
        window.nonmod_speed = 1.2;

        speechSynthesis.cancel();

        document.getElementById('polly_access_id').value = localStorage.getItem("polly_access_id");
        document.getElementById('polly_access_key').value = localStorage.getItem("polly_access_key");
        const awsCredentials = new AWS.Credentials(localStorage.getItem("polly_access_id"), localStorage.getItem("polly_access_key"));
        const settings = {
            awsCredentials: awsCredentials,
            awsRegion: "us-west-2",
            pollyVoiceId: "Seoyeon",
            cacheSpeech: true
        };

        window.kathy = new ChattyKathy(settings);
        window.users = [];
        window.speechQueue = [];
        
        // tokens before 21/02/13 9:06(GMT+9) are buggy(lacks required scopes)
        if (window.oauth !== "" && window.login !== "" && window.last_login_date > 1613174760) {
            $(document).on('click', function() {
                if(window.isclicked) return;
                window.isclicked = true;
                document.getElementById("divClick").style.display = "none";
                document.getElementById("divContent").style.display = "block";

                TAPIC.setup(window.oauth, function (username) {
                    TAPIC.setRefreshRate(10);

                    if (window.channelname === "") {
                        location.href = url.origin + url.pathname + "?channel=" + username;
                    } else {
                        TAPIC.joinChannel(window.channelname, function () {
                            checkTTS();
                        });
                    }
                });

                TAPIC.listen('message', function (e) {
                    parseMessage(e);
                });
            });
        } else {
            // there's no oauth key
            if (document.location.hash !== "" && document.location.hash.indexOf("access_token") !== -1) {
                //user already authed
                const rawauth = document.location.href.replace("#", "?");
                const authobj = new URL(rawauth);
                const oauth = getParams("access_token", rawauth);
                const state = getParams("state", rawauth);
                const localstate = localStorage.getItem("state");
                const last_url = localStorage.getItem("last_url");
                const last_url_obj = new URL(last_url);

                document.body.innerHTML = '';

                if (last_url_obj.origin !== authobj.origin) {
                    document.write("SECURITY ERROR");
                } else {
                    if (localstate === null || localstate === "" || state !== localstate) {
                        document.write("잘못된 state값이 전달되었습니다. 페이지를 새로고침 해보세요.<br />Invalid state. please refresh and retry.")
                    } else {
                        localStorage.setItem("oauth", oauth);
                        localStorage.setItem("state", "");
                        localStorage.setItem("last_url", "");
                        fetch(
                            'https://api.twitch.tv/helix/users',
                            {
                                "headers": {
                                    "Client-ID": window.oauth_client_id,
                                    "Authorization": "Bearer " + oauth
                                }
                            }
                        )
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(result) {
                            localStorage.setItem("login", result.data[0].login);
                            localStorage.setItem("display_name", result.data[0].display_name);
                            localStorage.setItem("last_login_date", Math.floor(new Date().getTime() / 1000));
                            
                            location.href = last_url;
                        });
                    }
                }
            } else {
                //not authed yet
                const state = md5(Date.now());
                localStorage.setItem("state", state);
                localStorage.setItem("last_url", location.href);
                
                document.body.innerHTML = '';
                document.write("트위치로 로그인해야 사용하실수 있습니다.<br />2021년 2월 13일 이전에 로그인하셨다면 로그인 방식 및 필요 권한 변경으로 다시 로그인하셔야 합니다.<br /><br /> <a href=\"https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=" +
                        window.oauth_client_id +
                        "&redirect_uri=" +
                        window.oauth_redirect_uri +
                        "&scope=bits:read%20channel:read:hype_train%20channel:read:redemptions%20channel:read:subscriptions%20chat:read%20chat:edit&state=" +
                        state +
                        "\">트위치 아이디로 로그인</a>");
            }
        }
    </script>
</body>
</html>
	
